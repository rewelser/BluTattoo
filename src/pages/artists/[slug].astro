---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import { render, getCollection, type CollectionEntry } from "astro:content";
import SquareAppointments from "../../components/SquareAppointments.astro";
import InstagramProfile from "../../components/InstagramProfile.astro";
// import { ArtistGallery } from "../../components/ArtistGallery.tsx";
import { ArtistGallery } from "../../components/ArtistGalleryNoThumbs.tsx";
import { Picture } from "astro:assets";

const isAsset = (v: unknown) => typeof v === "object" && v !== null && "src" in (v as any);

export async function getStaticPaths() {
  // const artists = await getCollection("artists");
  let artists = (await getCollection("artists")) as CollectionEntry<"artists">[];
  artists = artists.sort((a, b) =>
    a.data.order - b.data.order || a.data.title.localeCompare(b.data.title)
  );
  return artists.map((entry) => ({
    params: { slug: entry.id },
    props: { entry }
  }));
}

const { entry } = Astro.props;
const ig = entry.data.instagramUser;

// Render the Markdown *body* (the part after the frontmatter)
const { Content } = await render(entry);

const thumb = (src: string, w: number) =>
  src.replace("/uploads/artists/", `/uploads/_thumbs/artists/${w}/`);
---
<BaseLayout title={`BluTattoo Studio â€” ${entry.data.title}`}>
  <article class="mx-auto max-w-3xl space-y-6">
    <!-- <header class="space-y-2 flex flex-wrap sm:flex-nowrap items-center gap-4"> -->
    <header class="space-y-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
      {entry.data.photo && (
        <div class="portrait-anim portrait-glow">
          <img 
            src={entry.data.photo as string} 
            alt={`Portrait of ${entry.data.title}`} 
            width="400"
            height="400"
            loading="eager"
            decoding="async"
            class="portrait-img"
          />
          {/* <span class="portrait-glow" aria-hidden="true"></span> */}
        </div>
      )}
      <style>
        .portrait-anim.portrait-glow {
          --portrait-in: 6000ms;
          opacity: 0;
          transform: translate3d(-200px, 0, 0);
          filter: drop-shadow(-80px -10px 80px rgba(99, 102, 241, 0.35))
                  drop-shadow(-80px -10px 92px rgba(99, 102, 241, 0.18));
          animation: portraitIn var(--portrait-in) cubic-bezier(.2,.9,.2,1) forwards,
          glowIn var(--portrait-in) cubic-bezier(.2,.9,.2,1) forwards;
          will-change: transform, opacity;
        }

        @media (max-width: 640px) {
          .portrait-anim.portrait-glow {
            --portrait-in: 2000ms;
          }
        }

        @keyframes portraitIn {
          to {
            opacity: 1;
            transform: translate3d(0, 0, 0);
          }
        }

        @keyframes glowIn {
          to {
            /* filter: drop-shadow(-1px -10px 10px rgba(99, 102, 241, 0.35))
                    drop-shadow(-1px -10px 32px rgba(99, 102, 241, 0.18)); */
            filter: drop-shadow(-1px -10px 10px rgba(99, 102, 241, 0.35))
                    drop-shadow(-1px -10px 22px rgba(99, 102, 241, 0.18));
            /* filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.35))
                    drop-shadow(0 0 22px rgba(99, 102, 241, 0.18)); */
          }
        }

        @media (prefers-reduced-motion: reduce) {
          .portrait-anim {
            opacity: 1;
            transform: none;
            animation: none;
          }
        }
      </style>


      <div>
        <h1 class="text-3xl font-bold">{entry.data.title}</h1>
        {entry.data.styles?.length && (
          <p class="text-gray-600">{entry.data.styles.join(", ")}</p>
        )}
  
        {entry.data.instagram && (
          <p>
            <a
              href={entry.data.instagram}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 text-indigo-600 hover:underline"
            >
              <!-- tiny IG glyph -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                   fill="currentColor" class="h-4 w-4" aria-hidden="true">
                <path d="M7.75 2h8.5A5.75 5.75 0 0 1 22 7.75v8.5A5.75 5.75 0 0 1 16.25 22h-8.5A5.75 5.75 0 0 1 2 16.25v-8.5A5.75 5.75 0 0 1 7.75 2Zm0 1.5A4.25 4.25 0 0 0 3.5 7.75v8.5A4.25 4.25 0 0 0 7.75 20.5h8.5a4.25 4.25 0 0 0 4.25-4.25v-8.5A4.25 4.25 0 0 0 16.25 3.5h-8.5ZM12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10Zm0 1.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7ZM17 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/>
              </svg>
              Instagram
            </a>
          </p>
        )}
    
        {entry.data.bio && (
          <section>
            <h2 class="sr-only">Bio</h2>
            <p class="whitespace-pre-line">{entry.data.bio}</p>
          </section>
        )}
      </div>
    </header>

    <!-- Artist Gallery (no react thumbnail gallery) -->
    {entry.data.images?.length && (
      <section class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
        {entry.data.images.map((img, idx) => {
          return(
            <button
              type="button"
              class="overflow-hidden rounded text-left cursor-pointer"
              data-idx={idx}
              onclick={`window.dispatchEvent(new CustomEvent("open-lightbox", { detail: { index: ${idx} } }))`}
            >
              <img
                src={thumb(img.src as string, 360)}
                srcset={`${thumb(img.src as string, 240)} 240w,
                        ${thumb(img.src as string, 360)} 360w,
                        ${thumb(img.src as string, 480)} 480w,
                        ${thumb(img.src as string, 720)} 720w`}
                sizes="(max-width: 640px) 100vw, (max-width: 768px) 50vw, (max-width: 1024px) 33vw, 25vw"
                alt={img.alt ?? ""}
                loading="lazy"
                decoding="async"
                class="block w-full aspect-square object-cover"
              />
            </button>
          )
        })}
        <ArtistGallery
          client:load
          images={entry.data.images}
        />
      </section>
    )}

    {ig && (
      // <section class="mt-8 flex justify-center border-2 border-solid border-red-500">
      <section class="mt-8 flex justify-center">
        {/* <h2 class="text-xl font-semibold mb-4">Latest on Instagram</h2> */}
        <InstagramProfile username={ig} className="overflow-hidden w-xl" />
      </section>
    )}

    {/* Preferred: Square embed if present */}
    {entry.data.square?.enabled &&
    entry.data.square?.merchantSlug &&
    entry.data.square?.locationSlug && (
      <SquareAppointments
        merchantSlug={entry.data.square.merchantSlug}
        locationSlug={entry.data.square.locationSlug}
        label={entry.data.square.label}
        className="mt-2"
      />
    )}

    {/* Fallback: a plain external booking link */}
    {!entry.data.square && entry.data.booking_link && (
      <p>
        <a href={entry.data.booking_link} target="_blank" rel="noopener noreferrer"
          class="inline-block rounded bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700">
          Book with {entry.data.title}
        </a>
      </p>
    )}

    {/* Markdown body content (the part after the --- in the file) */}
    <section class="prose max-w-none">
      <Content />
    </section>
  </article>
</BaseLayout>
