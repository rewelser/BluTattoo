---
import type { CollectionEntry } from "astro:content";

type ArtistEntry = CollectionEntry<"artists">;

const {
  artists,
  logo_light,
  variant = "default",
} = Astro.props as {
  artists: ArtistEntry[];
  logo_light: string;
  variant?: "home" | "default";
};
---

<style>
  #mobile-header scroll-state(stuck: top) {
    /* Styles applied only when stuck to top */
    background-color: red;
  }
</style>

<!-- Mobile: single sticky bar (logo + menu button) -->
<header
  id="mobile-header"
  class={`md:hidden sticky top-0 z-50 border-b text-orange-100 relative ${
    variant !== "home" ? "bg-black/80 backdrop-blur" : ""
  }`}
  style="top: var(--announcement-h);"
>
  <!-- top row: logo + button -->
  <div
    class="flex items-center flex-col justify-center mx-auto max-w-6xl min-h-[10vh]"
  >
    <div
      id="mobile-logo-container"
      class="absolute"
      style="transform: translateY(-55vh)"
    >
      <a href="/" aria-label="BluTattoo Studio">
        <img
          id="mobile-logo"
          src={logo_light}
          alt=""
          class="w-auto p-2 h-[35vh]"
        />
        <span class="sr-only">BluTattoo Studio</span>
      </a>
    </div>

    <button
      id="mobile-menu-btn"
      class="hb hamburger hamburger--elastic inline-flex items-center border px-3 py-2 self-end"
      type="button"
      aria-haspopup="menu"
      aria-expanded="false"
      aria-controls="mobile-menu-panel"
      aria-label="Menu"
      data-burger
    >
      <span class="hamburger-box" aria-hidden="true">
        <span class="hamburger-inner"></span>
      </span>
    </button>
  </div>

  <!-- panel sits below the top row -->
  <div id="mobile-menu-panel" class="inset-x-0 top-full px-4 text-center">
    <!-- The element we animate is this wrapper -->
    <div
      id="mobile-menu-anim"
      class="overflow-hidden h-0 transition-[height] duration-300 ease-out will-change-[height]"
    >
      <nav class="p-2 shadow-xl" role="menu">
        <a href="/" class="block px-2 py-3 hover:bg-white/10">Home</a>

        <!-- Artists submenu -->
        <button
          id="artists-toggle"
          type="button"
          aria-expanded="false"
          aria-controls="artistsAnim"
          class="flex w-full items-center justify-center px-2 py-3 hover:bg-white/10"
        >
          <span>Artists</span>
          <svg
            viewBox="0 0 24 24"
            class="h-4 w-4 transition-transform fill-orange-100"
            aria-hidden="true"
          >
            <path d="M7 10l5 5 5-5H7z"></path>
          </svg>
        </button>

        <div
          id="artists-anim"
          class="overflow-hidden h-0 transition-[height] duration-200 ease-out will-change-[height]"
        >
          <ul
            class="ml-3 mt-2 flex max-h-[60vh] flex-col gap-1 overflow-auto pr-1 divide-y divide-white/10"
          >
            {
              artists.map((entry) => (
                <li>
                  <a
                    href={`/artists/${entry.id}/`}
                    class="block px-3 py-3 text-base hover:bg-white/10 focus:bg-white/10"
                    data-astro-prefetch="hover"
                  >
                    {entry.data.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </div>

        <a href="/piercing" class="block px-2 py-3 hover:bg-white/10"
          >Piercing</a
        >
        <a href="/events" class="block px-2 py-3 hover:bg-white/10">Events</a>
        <a href="/aftercare" class="block px-2 py-3 hover:bg-white/10"
          >Aftercare</a
        >
        <a href="/faq" class="block px-2 py-3 hover:bg-white/10">FAQ</a>
        <a href="/contact" class="block px-2 py-3 hover:bg-white/10"
          >Contact Us</a
        >
      </nav>
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    // mobile-menu.js
    const header = document.getElementById("mobile-header");
    const mobileBtn = document.querySelector(
      '[data-burger][id="mobile-menu-btn"]',
    );
    const mobileAnim = document.getElementById("mobile-menu-anim");
    const artistsBtn = document.getElementById("artists-toggle");
    const artistsAnim = document.getElementById("artists-anim");

    if (!header || !mobileBtn || !mobileAnim || !artistsBtn || !artistsAnim)
      return;

    const artistIcon = artistsBtn.querySelector("svg");

    const isExpanded = (btn) => btn.getAttribute("aria-expanded") === "true";

    const getTransitionMs = (el) => {
      const cs = getComputedStyle(el);
      const toMs = (s) =>
        s
          .split(",")
          .map((x) => x.trim())
          .map((x) => (x.endsWith("ms") ? parseFloat(x) : parseFloat(x) * 1000))
          .filter((n) => !Number.isNaN(n));
      const maxDur = Math.max(0, ...(toMs(cs.transitionDuration) || [0]));
      const maxDel = Math.max(0, ...(toMs(cs.transitionDelay) || [0]));
      console.log({ maxDur, maxDel });
      return maxDur + maxDel + 50;
    };

    const lock = (btn, panel) => {
      btn.disabled = true;
      btn.style.pointerEvents = "none";
      panel.style.pointerEvents = "none";
      panel.dataset.animating = "1";
    };

    const unlock = (btn, panel) => {
      delete panel.dataset.animating;
      btn.disabled = false;
      btn.style.pointerEvents = "";
      panel.style.pointerEvents = "";
    };

    const expand = (panel) => {
      console.log("expand", panel.id);
      const cs = getComputedStyle(panel);
      if (cs.height === "auto" || panel.style.height === "auto") {
        panel.style.height = panel.scrollHeight + "px";
        void panel.offsetHeight;
      }
      panel.style.height = panel.scrollHeight + "px";
      const onEnd = (e) => {
        if (e.propertyName !== "height") return;
        panel.style.height = "auto";
        panel.removeEventListener("transitionend", onEnd);
      };
      panel.addEventListener("transitionend", onEnd, { once: true });
    };

    const collapse = (panel) => {
      console.log("collapse", panel.id);
      const cs = getComputedStyle(panel);
      if (cs.height === "auto" || panel.style.height === "auto") {
        panel.style.height = panel.scrollHeight + "px";
        void panel.offsetHeight;
      }
      panel.style.height = "0px";
    };

    const snapClosed = (panel) => {
      console.log("snapClosed", panel.id);
      const prev = panel.style.transition;
      panel.style.transition = "none";
      if (
        getComputedStyle(panel).height === "auto" ||
        panel.style.height === "auto"
      ) {
        panel.style.height = panel.scrollHeight + "px";
        void panel.offsetHeight;
      }
      panel.style.height = "0px";
      void panel.offsetHeight;
      panel.style.transition = prev;
    };

    const setExpanded = (btn, panel, expanded, chevron = null) => {
      console.log("setExpanded", { btn: btn.id, panel: panel.id, expanded });
      if (header.dataset.animating === "1") return;
      btn.setAttribute("aria-expanded", expanded ? "true" : "false");
      chevron?.classList.toggle("rotate-180", expanded);

      lock(btn, panel);
      const totalMs = getTransitionMs(panel);
      let ended = false;
      const finish = () => {
        if (ended) return;
        ended = true;
        unlock(btn, panel);
      };
      const onEnd = (e) => {
        if (e.propertyName !== "height") return;
        panel.removeEventListener("transitionend", onEnd);
        clearTimeout(fallback);
        finish();
      };
      panel.addEventListener("transitionend", onEnd);

      const fallback = setTimeout(() => {
        finish();
      }, totalMs);

      expanded ? expand(panel) : collapse(panel);
    };

    // Ensure consistent initial state
    setExpanded(mobileBtn, mobileAnim, false);
    setExpanded(artistsBtn, artistsAnim, false, artistIcon);

    // Close both menus (used by outside click / ESC)
    const closeAll = () => {
      // if already closed, do nothing
      if (!isExpanded(mobileBtn) && !isExpanded(artistsBtn)) return;

      // First snap-close artists (and update its state)
      artistsBtn.setAttribute("aria-expanded", "false");
      if (artistIcon) artistIcon.classList.toggle("rotate-180", false);
      snapClosed(artistsAnim);

      // Then smoothly collapse outer
      setExpanded(mobileBtn, mobileAnim, false);
    };

    // --- interactions
    mobileBtn.addEventListener("click", () => {
      console.log("mobileBtn click");
      if (isExpanded(mobileBtn)) {
        console.log("mobileBtn click !open");
        console.log("isExpanded(mobileBtn)", isExpanded(mobileBtn));
        // closing outer => ensure artists is closed first
        artistsBtn.setAttribute("aria-expanded", "false");
        if (artistIcon) artistIcon.classList.toggle("rotate-180", false);
        snapClosed(artistsAnim);
      }
      console.log("isExpanded(mobileBtn)", isExpanded(mobileBtn));
      mobileBtn.classList.toggle("is-active");
      setExpanded(mobileBtn, mobileAnim, !isExpanded(mobileBtn));
      // todo: maybe migrate into setExpanded? or is redundant?:
      const controls = mobileBtn.getAttribute("aria-controls");
      const menu = controls && document.getElementById(controls);
      if (menu) menu.toggleAttribute("data-open", isExpanded(mobileBtn));
    });

    artistsBtn.addEventListener("click", () => {
      if (mobileAnim.dataset.animating === "1") return;
      setExpanded(artistsBtn, artistsAnim, !isExpanded(artistsBtn), artistIcon);
    });

    // --- close on outside click/touch ---------------------------------------

    // Use pointerdown for immediate response on touch + mouse.
    document.addEventListener(
      "pointerdown",
      (e) => {
        // Ignore if click is inside the header (menus/buttons/links)
        if (header.contains(e.target)) return;

        // Also ignore while outer is animating (avoids races)
        if (mobileAnim.dataset.animating === "1") return;

        closeAll();
      },
      { passive: true },
    );

    // Optional: close on Escape key for accessibility
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeAll();
    });
  })();
</script>

<script is:inline>
  // const hero = document.getElementById("backdrop-double");
  const hero = document.getElementById("hero-video-container");
  const overlay = document.getElementById("hero-video-scroll-wash");
  const mobilenav = document.getElementById("mobile-header");
  const logo = document.getElementById("mobile-logo");
  const logo_container = document.getElementById("mobile-logo-container");
  const mobile_menu_btn = document.getElementById("mobile-menu-btn");
  const promo_bar = document.getElementById("promo-bar");

  // If you render this on pages without the hero, bail early to avoid errors.
  if (
    !hero ||
    !overlay ||
    !mobilenav ||
    !logo ||
    !logo_container ||
    !mobile_menu_btn
  ) {
    // Still okay if menu exists without hero (non-home pages), but your current script assumes hero.
    // You can decide whether to return here or add fallbacks.
  }

  const MAX_ALPHA = 0.8;
  const MAX_BLUR_PX = 8;
  const MAX_SCALE = 2;
  const MAX_OPACITY = 1;

  // Guard in case overlay doesn't exist on a page.
  if (overlay) {
    overlay.style.backgroundColor = "rgba(0,0,0,0)";
    overlay.style.backdropFilter = "blur(0px)";
    overlay.style.webkitBackdropFilter = "blur(0px)";
  }

  if (mobile_menu_btn) mobile_menu_btn.style.opacity = 0;

  let ticking = false;

  function clamp01(x) {
    return Math.max(0, Math.min(1, x));
  }

  function update() {
    ticking = false;
    if (!hero || !mobilenav || !logo || !logo_container || !mobile_menu_btn)
      return;

    function vhToPx(vh) {
      return (vh / 100) * document.documentElement.clientHeight;
    }

    const rect = hero.getBoundingClientRect();

    const promo_bar_height =
      promo_bar && promo_bar.style.display !== "none"
        ? parseInt(promo_bar.style.height)
        : 0;

    const earlyFinishPx = vhToPx(10) + promo_bar_height;
    const denom = Math.max(1, rect.height - earlyFinishPx);

    const progress = clamp01(-rect.y / denom);

    const alpha = progress * MAX_ALPHA;
    const blur = progress * MAX_BLUR_PX;
    const opacity = progress * MAX_OPACITY;

    if (overlay) {
      overlay.style.backgroundColor = `rgba(0,0,0,${alpha.toFixed(2)})`;
      overlay.style.backdropFilter = `blur(${blur.toFixed(2)}px)`;
      overlay.style.webkitBackdropFilter = `blur(${blur.toFixed(2)}px)`;
    }

    mobilenav.style.backgroundColor = `rgba(0,0,0,${alpha.toFixed(2)})`;
    mobilenav.style.backdropFilter = `blur(${blur.toFixed(2)}px)`;
    mobilenav.style.webkitBackdropFilter = `blur(${blur.toFixed(2)}px)`;

    mobile_menu_btn.style.opacity = `${opacity.toFixed(2)}`;

    const lerp = (a, b, t) => a + (b - a) * t;

    const startTranslateYVh = -55;
    const startHeightVh = 35;
    const endHeightVh = 10;

    const translateYVh = lerp(startTranslateYVh, 0, progress);
    const heightVh = lerp(startHeightVh, endHeightVh, progress);

    logo_container.style.transform = `translateY(${translateYVh}vh)`;
    logo.style.height = `${heightVh.toFixed(2)}vh`;
  }

  function onScrollOrResize() {
    if (ticking) return;
    ticking = true;
    requestAnimationFrame(update);
  }

  window.addEventListener("scroll", onScrollOrResize, { passive: true });
  window.addEventListener("resize", onScrollOrResize);
  update();
</script>
