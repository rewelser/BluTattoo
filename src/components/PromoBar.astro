---
const {
  id = "promo-bar",
  height = 40, // px number
  storageKey = "bt_promo_dismissed",
  message = "Now booking March!",
  href = "/booking",
  color1,
  color2,
} = Astro.props;

const h = `${height}px`;

// const defaultBg = "linear-gradient(90deg, #020024 0%, #005eff 100%)";
const defaultBg = "linear-gradient(90deg, #020024 0%, #5613ff 100%)";

const c1 = typeof color1 === "string" && color1.trim() ? color1.trim() : "";
const c2 = typeof color2 === "string" && color2.trim() ? color2.trim() : "";

// Rules:
// - 0 colors -> default gradient
// - 1 color  -> solid
// - 2 colors -> simple 2-stop gradient
const background =
  c1 && c2
    ? `linear-gradient(90deg, ${c1} 0%, ${c2} 100%)`
    : c1
      ? c1
      : defaultBg;
---

<!-- Spacer: keeps layout from sliding under the fixed bar -->
<div id={`${id}-spacer`} style={`height:${h};`} aria-hidden="true"></div>

<aside
  id={id}
  class="fixed top-0 left-0 w-full z-[80]"
  style={`height:${h};`}
  role="region"
  aria-label="Announcement"
>
  <div
    class="h-full flex items-center justify-center gap-3 px-4 text-white text-sm sm:text-base md:text-2xl"
    style={`background: ${background};`}
  >
    <a
      class="promo-outline flex items-center justify-center w-full h-full text-center"
      href={href}
    >
      {message}
    </a>
    <button
      type="button"
      class="ml-auto px-2 py-1 leading-none cursor-pointer"
      aria-label="Dismiss announcement"
      data-dismiss
    >
      âœ•
    </button>
  </div>

  <script is:inline define:vars={{ storageKey, id }}>
    (() => {
      const banner = document.getElementById(id);
      const spacer = document.getElementById(`${id}-spacer`);
      if (!banner || !spacer) return;

      const hide = () => {
        banner.style.display = "none";
        spacer.style.display = "none";
        document.documentElement.style.removeProperty("--announcement-h");
      };

      // if dismissed before, hide immediately
      // try {
      //   // if (localStorage.getItem(storageKey) === "1") hide();
      //   // else document.documentElement.style.setProperty("--announcement-h", spacer.style.height);
      //   // always setting it for now to test
      //   document.documentElement.style.setProperty(
      //     "--announcement-h",
      //     spacer.style.height,
      //   );
      // } catch {}

      try {
        if (localStorage.getItem(storageKey) === "1" && false) hide(); // todo: remove false for prod
        else
          document.documentElement.style.setProperty(
            "--announcement-h",
            spacer.style.height,
          );
      } catch {
        document.documentElement.style.setProperty(
          "--announcement-h",
          spacer.style.height,
        );
      }

      banner.querySelector("[data-dismiss]")?.addEventListener("click", () => {
        try {
          localStorage.setItem(storageKey, "1");
        } catch {}
        hide();
      });
    })();
  </script>
</aside>
