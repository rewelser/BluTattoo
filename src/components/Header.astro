---
import { getCollection, type CollectionEntry, getEntry } from "astro:content";
import branding from "../content/branding.json";
import BlobRow from "../components/decor/BlobRow copy.astro";
import PromoBar from "./PromoBar.astro";

// Load & order artists
let artists = (await getCollection("artists")) as CollectionEntry<"artists">[];
artists = artists.sort(
  (a, b) =>
    (a.data.order ?? 999) - (b.data.order ?? 999) ||
    a.data.title.localeCompare(b.data.title),
);

// Active link helper
const currentPath = Astro.url.pathname;
const isActive = (href: string) =>
  currentPath === href || (href !== "/" && currentPath.startsWith(href));

// Load site branding (logo)
const site = await getEntry("siteInfo", "main");
const logo =
  branding?.logo ?? "/uploads/misc_images/logos/blutattoo-trimmed.svg";

const { variant = "default" } = Astro.props; // "home" | "default"
---

<!-- Promo announcement bar -->
<PromoBar />

{
  variant === "home" && (
    <>
      {/* Video backdrop */}
      <div class="sticky top-0 w-full h-screen z-0">
        {/* <img
      src="/uploads/misc_images/hero-poster.jpg"
      alt=""
      class="h-full w-full object-cover"
      loading="eager"
      decoding="async"
    /> */}

        <video
          id="heroVideo"
          class="h-full w-full object-cover"
          autoplay
          muted
          loop
          playsinline
          preload="none"
          aria-hidden="true"
          data-src-mp4="/uploads/misc_videos/hero-720.mp4"
          data-src-webm="/uploads/misc_videos/hero-720.webm"
        >
          <source src="/uploads/misc_videos/hero-720.webm" type="video/webm" />
          <source src="/uploads/misc_videos/hero-720.mp4" type="video/mp4" />
        </video>

        {/* optional: subtle wash for legibility */}
        {/* <div class="absolute inset-0 bg-black/20"></div> */}
      </div>

      {/* Top LOGO (desktop only, not sticky) */}
      <div
        id="desktop-top-logo"
        class="hidden md:block absolute top-0 w-screen h-screen"
      >
        <div class="mx-auto px-4 h-full">
          <a
            href="/"
            class="flex items-center py-6 md:py-8 h-full"
            aria-label="BluTattoo Studio"
          >
            <img
              src={logo}
              alt="BluTattoo Studio"
              class="w-fit mx-auto h-20 md:h-100"
            />
          </a>
        </div>
      </div>
    </>
  )
}

{
  variant !== "home" && (
    // Top LOGO (desktop only, not sticky)
    <div id="desktop-top-logo" class="hidden md:block top-0">
      <div class="mx-auto px-4 h-full">
        <a
          href="/"
          class="flex items-center py-6 md:py-8 h-full"
          aria-label="BluTattoo Studio"
        >
          <img
            src={logo}
            alt="BluTattoo Studio"
            class="w-fit mx-auto h-20 md:h-50"
          />
        </a>
      </div>
    </div>
  )
}

<!-- Sticky NAV (desktop) -->
<div
  id="sticky-nav-desktop"
  class="hidden md:block sticky top-0 border-b z-50 bg-black/60 bg-white backdrop-blur-sm"
  style="top: var(--announcement-h);"
>
  <nav class="mx-auto max-w-6xl px-4">
    <ul class="flex items-center justify-center gap-8 py-3">
      <li>
        <a
          href="/"
          data-astro-prefetch="hover"
          class={`hover:underline ${
            isActive("/") ? "font-semibold underline text-indigo-400" : ""
          }`}
        >
          HOME
        </a>
      </li>

      <li class="relative group">
        <details class="relative">
          <summary
            class={`list-none cursor-pointer flex items-center gap-1 hover:underline ${
              isActive("/artists")
                ? "font-semibold underline text-indigo-400"
                : ""
            }`}
          >
            ARTISTS
            <svg
              class="fill-current"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              aria-hidden="true"
            >
              <path d="M7 10l5 5 5-5H7z"></path>
            </svg>
          </summary>
          <ul
            role="menu"
            class="absolute left-1/2 -translate-x-1/2 mt-2 w-64 border bg-black/95 text-orange-100 backdrop-blur p-2 shadow-lg z-20"
          >
            {
              artists.map((entry) => (
                <li role="none">
                  <a
                    role="menuitem"
                    href={`/artists/${entry.id}/`}
                    class="block px-3 py-2 hover:outline-1 hover:outline-orange-100"
                    data-astro-prefetch="hover"
                  >
                    {entry.data.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </details>
      </li>

      <li>
        <a
          href="/piercing"
          data-astro-prefetch="hover"
          class={`hover:underline ${
            isActive("/piercing")
              ? "font-semibold underline text-indigo-400"
              : ""
          }`}
        >
          PIERCING
        </a>
      </li>

      <li>
        <a
          href="/aftercare"
          data-astro-prefetch="hover"
          class={`hover:underline ${
            isActive("/aftercare")
              ? "font-semibold underline text-indigo-400"
              : ""
          }`}
        >
          AFTERCARE
        </a>
      </li>

      <li>
        <a
          href="/faq"
          data-astro-prefetch="hover"
          class={`hover:underline ${
            isActive("/faq") ? "font-semibold underline text-indigo-400" : ""
          }`}
        >
          FAQ
        </a>
      </li>

      <li>
        <a
          href="/contact"
          data-astro-prefetch="hover"
          class={`hover:underline ${
            isActive("/contact")
              ? "font-semibold underline text-indigo-400"
              : ""
          }`}
        >
          CONTACT US
        </a>
      </li>
    </ul>
  </nav>
</div>

<!-- Mobile: single sticky bar (logo + menu button) -->
<header
  id="mobileHeader"
  class="md:hidden sticky top-0 z-50 border-b bg-black/80 text-orange-100 backdrop-blur relative"
>
  <!-- top row: logo + button -->
  <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
    <a href="/" class="flex items-center gap-2" aria-label="BluTattoo Studio">
      <img src={logo} alt="" class="h-15 w-auto" />
      <span class="sr-only">BluTattoo Studio</span>
    </a>

    <button
      id="mobileMenuBtn"
      type="button"
      aria-haspopup="menu"
      aria-expanded="false"
      aria-controls="mobileMenuPanel"
      class="inline-flex items-center gap-2 border px-3 py-2"
    >
      Menu
      <svg
        viewBox="0 0 24 24"
        class="h-4 w-4 transition-transform fill-orange-100"
        aria-hidden="true"
      >
        <path d="M7 10l5 5 5-5H7z"></path>
      </svg>
    </button>
  </div>

  <!-- panel sits below the top row -->
  <div id="mobileMenuPanel" class="inset-x-0 top-full mt-2 px-4 text-center">
    <!-- The element we animate is this wrapper -->
    <div
      id="mobileMenuAnim"
      class="overflow-hidden h-0 transition-[height] duration-300 ease-out will-change-[height]"
    >
      <nav class="p-2 shadow-xl" role="menu">
        <a href="/" class="block px-2 py-3 hover:bg-white/10">Home</a>

        <!-- Artists submenu -->
        <button
          id="artistsToggle"
          type="button"
          aria-expanded="false"
          aria-controls="artistsAnim"
          class="flex w-full items-center justify-center px-2 py-3 hover:bg-white/10"
        >
          <span>Artists</span>
          <svg
            viewBox="0 0 24 24"
            class="h-4 w-4 transition-transform fill-orange-100"
            aria-hidden="true"
          >
            <path d="M7 10l5 5 5-5H7z"></path>
          </svg>
        </button>

        <div
          id="artistsAnim"
          class="overflow-hidden h-0 transition-[height] duration-200 ease-out will-change-[height]"
        >
          <ul
            class="ml-3 mt-2 flex max-h-[60vh] flex-col gap-1 overflow-auto pr-1 divide-y divide-white/10"
          >
            {
              artists.map((entry) => (
                <li>
                  <a
                    href={`/artists/${entry.id}/`}
                    class="block px-3 py-3 text-base hover:bg-white/10 focus:bg-white/10"
                    data-astro-prefetch="hover"
                  >
                    {entry.data.title}
                  </a>
                </li>
              ))
            }
          </ul>
        </div>
        <a href="/piercing" class="block px-2 py-3 hover:bg-white/10">Piercing</a>
        <a href="/aftercare" class="block px-2 py-3 hover:bg-white/10">Aftercare</a>
        <a href="/faq" class="block px-2 py-3 hover:bg-white/10">FAQ</a>
        <a href="/contact" class="block px-2 py-3 hover:bg-white/10">Contact Us</a>
      </nav>
    </div>
  </div>
</header>

<style>
  summary {
    list-style: none;
  }
  summary::-webkit-details-marker {
    display: none;
  }

  @media (min-width: 768px) {
    /* open-on-hover convenience for desktop dropdown */
    details > ul {
      display: none;
    }
    details[open] > ul {
      display: block;
    }
    details.group:hover > ul {
      display: block;
    }
  }
</style>
